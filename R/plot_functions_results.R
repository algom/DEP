#' Plot values for a protein of interest
#'
#' \code{plot_single} generates a barplot of a protein of interest.
#'
#' @param dep SummarizedExperiment,
#' Data object which has been generated
#' by \code{\link{test_diff}} and \code{\link{add_rejections}}.
#' @param protein Character,
#' Protein name.
#' @param type 'centered' or 'contrast',
#' The type of data scaling used for plotting.
#' @return A barplot (generated by \code{\link[ggplot2]{ggplot}}).
#' @examples
#' data <- UbiLength
#' data <- data[data$Reverse != '+' & data$Potential.contaminant != '+',]
#' data_unique <- make_unique(data, 'Gene.names', 'Protein.IDs', delim = ';')
#'
#' columns <- grep('LFQ.', colnames(data_unique))
#' exp_design <- UbiLength_ExpDesign
#' se <- make_se(data_unique, columns, exp_design)
#'
#' filt <- filter_missval(se, thr = 0)
#' norm <- normalize_vsn(filt)
#' imputed <- impute(norm, fun = 'MinProb', q = 0.01)
#'
#' diff <- test_diff(imputed, 'Ctrl', 'control')
#' dep <- add_rejections(diff, alpha = 0.05, lfc = 1)
#'
#' plot_single(dep, 'USP15', 'centered')
#' plot_single(dep, 'USP15', 'contrast')
#' @export
plot_single <- function(dep, protein, type) {
  # Show error if inputs are not the required classes
  assertthat::assert_that(inherits(dep, "SummarizedExperiment"),
                          is.character(protein),
                          is.character(type))

  # Show error if inputs do not contain required columns
  if(any(!c("label", "condition", "replicate") %in% colnames(colData(dep)))) {
    stop(paste0("'label', 'condition' and/or 'replicate' columns are not present in '",
                deparse(substitute(dep)),
                "'.\nRun make_se() or make_se_parse() to obtain the required columns."),
         call. = FALSE)
  }
  if(length(grep("_p.adj|_diff", colnames(rowData(dep)))) < 1) {
    stop(paste0("'[contrast]_diff' and '[contrast]_p.adj' columns are not present in '",
                deparse(substitute(dep)),
                "'.;\nRun test_diff() to obtain the required columns."),
         call. = FALSE)
  }
  if(!"name" %in% colnames(rowData(dep))) {
    stop(paste0("'name' column not present in '",
                deparse(substitute(dep)), "'"),
         call. = FALSE)
  }
  # Show error if an unvalid type is given
  if(!type %in% c("centered", "contrast")) {
    stop("run plot_single() with a valid type;\nValid types are: 'centered', 'contrast'",
         call. = FALSE)
  }
  # Show error if an unvalid protein name is given
  if(length(which(rowData(dep)$name == protein)) == 0) {
    possibilities <-
      rowData(dep)$name[grep(substr(protein, 1, nchar(protein) - 1),
                             rowData(dep)$name)]
    if(length(possibilities) > 0) {
      possibilities_msg <- paste0("Do you mean: '",
                                  paste0(possibilities, collapse = "', '"),
                                  "'")
    } else {
      possibilities_msg <- NULL
    }
    stop("please run `plot_single()` with a valid protein name as argument\n",
         possibilities_msg,
         call. = FALSE)
  }

  # Plot either the average protein-centered enrichment values
  #per condition ('centered') or the average enrichments of conditions
  #versus the control condition ('contrast') for a single protein
  if(type == "centered") {
    # Obtain protein-centered enrichment values
    rowData(dep)$mean <- rowMeans(assay(dep))
    df <- assay(dep) - rowData(dep)$mean
    df <- data.frame(df) %>% rownames_to_column()
    # Select values for a single protein in long format and add sample annotation
    df_reps <- filter(df, rowname == protein) %>%
      gather(ID, val, 2:ncol(.)) %>%
      left_join(., data.frame(colData(dep)), by = "ID")
    df_reps$replicate <- as.factor(df_reps$replicate)
    df_mean <- df_reps %>%
      group_by(condition) %>%
      summarize(mean = mean(val), sd = sd(val), n = n()) %>%
      mutate(error = qnorm(0.975) * sd / sqrt(n),
             CI.L = mean - error,
             CI.R = mean + error)
    # Plot the centered enrichment values for the replicates as well as the mean
    p1 <- ggplot(df_mean, aes(condition, mean)) +
      geom_hline(yintercept = 0) +
      geom_col(colour = "black", fill = "grey") +
      geom_point(data = df_reps, aes(condition, val, col = replicate),
                 shape = 18, size = 5, position = position_dodge(width=0.3)) +
      geom_errorbar(aes(ymin = CI.L, ymax = CI.R), width = 0.3) +
      labs(title = protein,
           x = "Baits",
           y = "Enrichment (log2; 95% CI)",
           col = "rep") +
      theme_DEP2()
  }
  if(type == "contrast") {
    # Select values for a single protein
    df <- rowData(dep) %>%
      data.frame() %>%
      filter(name == protein) %>%
      column_to_rownames(var = "name") %>%
      select(ends_with("_diff"),
             ends_with("_CI.L"),
             ends_with("_CI.R")) %>%
      gather(var, val) %>%
      mutate(condition = gsub("_diff|_CI.L|_CI.R", "", var),
             var = gsub(".*_", "", var)) %>%
      spread(var, val)
    # Plot the average enrichments of conditions versus the control condition
    p1 <- ggplot(df, aes(condition, diff)) +
      geom_hline(yintercept = 0) +
      geom_col(colour = "black", fill = "grey") +
      geom_errorbar(aes(ymin = CI.L, ymax = CI.R), width = 0.3) +
      labs(title = protein,
           x = "",
           y = "Enrichment (log2; 95% CI)") +
      theme_DEP2()
  }
  p1
}

#' Plot a heatmap
#'
#' \code{plot_heatmap} generates a heatmap of all significant proteins.
#'
#' @param dep SummarizedExperiment,
#' Data object which has been generated by
#' \code{\link{test_diff}} and \code{\link{add_rejections}}.
#' @param type 'centered' or 'contrast',
#' The type of data scaling used for plotting.
#' @param k Integer,
#' sets the number of k-means clusters.
#' @param col_limit Integer,
#' sets the outer limits of the color scale.
#' @param labelsize Integer,
#' sets the size of name labels.
#' @return A heatmap (generated by \code{\link[ComplexHeatmap]{Heatmap}})
#' @examples
#' data <- UbiLength
#' data <- data[data$Reverse != '+' & data$Potential.contaminant != '+',]
#' data_unique <- make_unique(data, 'Gene.names', 'Protein.IDs', delim = ';')
#'
#' columns <- grep('LFQ.', colnames(data_unique))
#' exp_design <- UbiLength_ExpDesign
#' se <- make_se(data_unique, columns, exp_design)
#'
#' filt <- filter_missval(se, thr = 0)
#' norm <- normalize_vsn(filt)
#' imputed <- impute(norm, fun = 'MinProb', q = 0.01)
#'
#' diff <- test_diff(imputed, 'Ctrl', 'control')
#' dep <- add_rejections(diff, alpha = 0.05, lfc = 1)
#'
#' plot_heatmap(dep, 'centered', k = 6, col_limit = 4, labelsize = 3)
#' plot_heatmap(dep, 'contrast', k = 6, col_limit = 10, labelsize = 3)
#' @export
plot_heatmap <- function(dep, type, k = 6, col_limit = 6, labelsize = 10) {
  # Show error if inputs are not the required classes
  if(is.integer(k)) k <- as.numeric(k)
  if(is.integer(col_limit)) col_limit <- as.numeric(col_limit)
  if(is.integer(labelsize)) labelsize <- as.numeric(labelsize)
  assertthat::assert_that(inherits(dep, "SummarizedExperiment"),
                          is.character(type),
                          is.numeric(k),
                          is.numeric(col_limit),
                          is.numeric(labelsize))

  # Show error if inputs do not contain required columns
  if(any(!c("label", "condition", "replicate") %in% colnames(colData(dep)))) {
    stop(paste0("'label', 'condition' and/or 'replicate' columns are not present in '",
                deparse(substitute(dep)), "'"),
         call. = FALSE)
  }
  if(length(grep("_diff", colnames(rowData(dep)))) < 1) {
    stop(paste0("'[contrast]_diff' columns are not present in '",
                deparse(substitute(dep)),
                "'.\nRun test_diff() to obtain the required columns."),
         call. = FALSE)
  }
  if(!"significant" %in% colnames(rowData(dep))) {
    stop(paste0("'significant' column is not present in '",
                deparse(substitute(dep)),
                "'.\nRun add_rejections() to obtain the required column."),
         call. = FALSE)
  }

  # Show error if an unvalid type is given
  if(!type %in% c("centered", "contrast")) {
    stop("run plot_heatmap() with a valid type;\nValid types are: 'centered', 'contrast'",
         call. = FALSE)
  }

  # Filter for significant proteins only
  dep <- dep[rowData(dep)$significant, ]

  # Plot a heatmap of the average protein-centered enrichment values
  # per condition ('centered') or the average enrichments of conditions
  # versus the control condition ('contrast')
  if (type == "centered") {
    # Obtain protein-centered enrichment values
    rowData(dep)$mean <- rowMeans(assay(dep))
    df <- assay(dep) - rowData(dep)$mean

    # Perform k-means clustering
    set.seed(1)
    kmeans <- kmeans(df, k)
    # Order the k-means clusters according to the maximum enrichment
    # in all samples averaged over the proteins in the cluster
    order <- df %>%
      data.frame() %>%
      cbind(., cluster = kmeans$cluster) %>%
      mutate(row = apply(.[, 1:(ncol(.) - 1)], 1, function(x) max(x))) %>%
      group_by(cluster) %>%
      summarize(index = sum(row)/n()) %>%
      arrange(desc(index)) %>%
      collect %>%
      .[[1]] %>%
      match(seq(1:k), .)
    kmeans$cluster <- order[kmeans$cluster]
  }
  if (type == "contrast") {
    # Obtain average enrichments of conditions versus the control condition
    df <- rowData(dep) %>%
      data.frame() %>%
      column_to_rownames(var = "name") %>%
      select(ends_with("_diff"))
    colnames(df) <-
      gsub("_diff", "", colnames(df)) %>%
      gsub("_vs_", " - ", .)

    # Perform k-means clustering
    set.seed(1)
    kmeans <- kmeans(df, k)
    # Order the k-means clusters according to their average enrichment
    order <- cbind(df, cluster = kmeans$cluster) %>%
      gather(condition, diff, 1:(ncol(.) - 1)) %>%
      group_by(cluster) %>%
      summarize(row = mean(diff)) %>%
      arrange(desc(row)) %>%
      collect %>%
      .[[1]] %>%
      match(seq(1:k), .)
    kmeans$cluster <- order[kmeans$cluster]
  }

  if (ncol(df) == 1) {
    clust = FALSE
  } else {
    clust = TRUE
  }

  # Plot the heatmap
  ht1 = Heatmap(df,
                col = circlize::colorRamp2(
                  seq(-col_limit, col_limit, (col_limit/5)),
                  rev(RColorBrewer::brewer.pal(11, "RdBu"))),
                split = kmeans$cluster,
                cluster_columns = TRUE,
                cluster_rows = clust,
                na_col = "grey",
                clustering_distance_rows = "euclidean",
                clustering_distance_columns = "euclidean",
                row_names_side = "left",
                column_names_side = "top",
                show_row_names = TRUE,
                show_column_names = TRUE,
                heatmap_legend_param = list(color_bar = "continuous",
                                            legend_direction = "horizontal",
                                            legend_width = unit(5, "cm"),
                                            title_position = "lefttop"),
                name = "Enrichment (log2)",
                row_names_gp = gpar(fontsize = labelsize),
                column_names_gp = gpar(fontsize = 16))
  draw(ht1, heatmap_legend_side = "top")
}

#' Volcano plot
#'
#' \code{plot_volcano} generates a volcano plot for a specified contrast.
#'
#' @param dep SummarizedExperiment,
#' Data object which has been generated by
#' \code{\link{test_diff}} and \code{\link{add_rejections}}.
#' @param contrast Character,
#' The specific contrast to plot.
#' @param labelsize Integer,
#' sets the size of name labels.
#' @param add_names Boolean,
#' whether or not to plot names.
#' @return A volcano plot (generated by \code{\link[ggplot2]{ggplot}})
#' @examples
#' data <- UbiLength
#' data <- data[data$Reverse != '+' & data$Potential.contaminant != '+',]
#' data_unique <- make_unique(data, 'Gene.names', 'Protein.IDs', delim = ';')
#'
#' columns <- grep('LFQ.', colnames(data_unique))
#' exp_design <- UbiLength_ExpDesign
#' se <- make_se(data_unique, columns, exp_design)
#'
#' filt <- filter_missval(se, thr = 0)
#' norm <- normalize_vsn(filt)
#' imputed <- impute(norm, fun = 'MinProb', q = 0.01)
#'
#' diff <- test_diff(imputed, 'Ctrl', 'control')
#' dep <- add_rejections(diff, alpha = 0.05, lfc = 1)
#'
#' plot_volcano(dep, 'Ubi6_vs_Ctrl', labelsize = 5, add_names = TRUE)
#' plot_volcano(dep, 'Ubi6_vs_Ctrl', add_names = FALSE)
#' plot_volcano(dep, 'Ubi4_vs_Ctrl', labelsize = 5, add_names = TRUE)
#' plot_volcano(dep, 'Ubi4_vs_Ctrl', add_names = FALSE)
#' @export
plot_volcano <- function(dep, contrast, labelsize = 3, add_names = TRUE) {
  # Show error if inputs are not the required classes
  if(is.integer(labelsize)) labelsize <- as.numeric(labelsize)
  assertthat::assert_that(inherits(dep, "SummarizedExperiment"),
                          is.character(contrast),
                          is.numeric(labelsize),
                          is.logical(add_names))

  # Show error if inputs do not contain required columns
  if(any(!c("name", "ID") %in% colnames(rowData(dep)))) {
    stop(paste0("'name' and/or 'ID' columns are not present in '",
                deparse(substitute(dep)),
                "'.\nRun make_unique() to obtain required columns."),
         call. = FALSE)
  }
  if(length(grep("_p.adj|_diff", colnames(rowData(dep)))) < 1) {
    stop(paste0("'[contrast]_diff' and '[contrast]_p.adj' columns are not present in '",
                deparse(substitute(dep)),
                "'.\nRun test_diff() to obtain the required columns."),
         call. = FALSE)
  }
  if(length(grep("_significant", colnames(rowData(dep)))) < 1) {
    stop(paste0("'[contrast]_significant' columns are not present in '",
                deparse(substitute(dep)),
                "'.\nRun add_rejections() to obtain the required columns."),
         call. = FALSE)
  }

  row_data <- rowData(dep)

  # Show error if an unvalid contrast is given
  if (length(grep(paste(contrast, "_diff", sep = ""),
                  colnames(row_data))) == 0) {
    valid_cntrsts <- row_data %>%
      data.frame() %>%
      select(ends_with("_diff")) %>%
      colnames(.) %>%
      gsub("_diff", "", .)
    valid_cntrsts_msg <- paste0("Valid contrasts are: '",
                                paste0(valid_cntrsts, collapse = "', '"),
                                "'")
    stop("Not a valid contrast, please run `plot_volcano()` with a valid contrast as argument\n",
         valid_cntrsts_msg,
         call. = FALSE)
  }

  # Generate a data.frame containing all info for the volcano plot
  diff <- grep(paste(contrast, "_diff", sep = ""),
               colnames(row_data))
  padj <- grep(paste(contrast, "_p.adj", sep = ""),
               colnames(row_data))
  signif <- grep(paste(contrast, "_significant", sep = ""),
                 colnames(row_data))
  df <- data.frame(x = row_data[, diff],
                   y = -log10(row_data[, padj]),
                   z = row_data[, signif],
                   name = row_data$name)
  signif_prots <- df %>% filter(z)
  name1 <- gsub("_vs_.*", "", contrast)
  name2 <- gsub(".*_vs_", "", contrast)

  # Plot volcano with or without labels
  if (add_names) {
    p1 <- ggplot(df, aes(x, y)) +
      geom_vline(xintercept = 0) +
      geom_point(col = "grey") +
      geom_point(data = signif_prots, col = "black") +
      ggrepel::geom_text_repel(data = signif_prots,
                               aes(label = name),
                               size = labelsize,
                               box.padding = unit(0.1, 'lines'),
                               point.padding = unit(0.1, 'lines'),
                               segment.size = 0.5) +
      geom_text(data = data.frame(), aes(x = c(Inf, -Inf),
                                         y = c(-Inf, -Inf),
                                         hjust = c(1, 0),
                                         vjust = c(-1, -1),
                                         label = c(name1, name2),
                                         size = 5,
                                         fontface = "bold")) +
      labs(x = "Fold change (log2)", y = "Adjusted p-value (-log10)") +
      theme_DEP1() +
      theme(legend.position = "none")
  } else {
    p1 <- ggplot(df, aes(x, y)) +
      geom_vline(xintercept = 0) +
      geom_point(col = "grey") +
      geom_point(data = signif_prots, col = "black") +
      geom_text(data = data.frame(), aes(x = c(Inf, -Inf),
                                         y = c(-Inf, -Inf),
                                         hjust = c(1, 0),
                                         vjust = c(-1, -1),
                                         label = c(name1, name2),
                                         size = 5,
                                         fontface = "bold")) +
      labs(x = "Fold change (log2)", y = "Adjusted p-value (-log10)") +
      theme_DEP1() +
      theme(legend.position = "none")
  }
  p1
}
